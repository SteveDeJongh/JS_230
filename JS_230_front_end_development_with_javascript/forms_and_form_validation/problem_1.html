<!DOCTYPE html>
<html>
  <head>
    <title>Form Validation, Part 1</title>
    <style>
      * {
        box-sizing: border-box;
      }

      h1 {
        color: #fff;
        font-size: 24px;
        width: 800px;
        margin: 70px auto 0 auto;
      }
      body {
        background: #52be43;
        font-size: 18px;
      }

      form {
        width: 800px;
        margin: 15px auto;
        background: #fff;
        padding: 20px;
        border-radius: 4px;
      }

      dt {
        padding: 20px 0 5px 0;
      }

      input {
        font-size: 18px;
        width: 300px;
        height: 38px;
        padding: 3px 10px;
        outline: none;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      input:focus {
        border: 1px solid #52be43;
      }

      .invalid_field {
        border: 1px solid #a93333;
      }

      .error_message {
        display: inline-block;
        margin-left: 30px;
      }

      button {
        margin-top: 20px;
        font-size: 16px;
        font-weight: bold;
        outline: none;
        color: #fff;
        padding: 5px 15px;
        border-radius: 4px;
        background: #52be43;
        border: none;
      }

      .form_errors, .error_message {
        color: #a93333;
      }

      .success {
        color: green;
        border: 1px solid #52be43;
      }

      .creditCard {
        width: 60px;
      }
    </style>
    <script>
      document.addEventListener('DOMContentLoaded', e => {
        // let formValidation = {
        //   firstName: document.querySelector('#firstname'),
        //   lastName: document.querySelector('#lastname'),
        //   email: document.querySelector('#email'),
        //   password: document.querySelector('#password'),
        //   phone: document.querySelector('#phone'),
        //   inputs: document.querySelectorAll('input'),
        //   form: document.querySelector('form'),
        //   formStatus: document.querySelector('.form_errors'),
        //   button: document.querySelector('button'),

        //   bindEvents() {
        //     this.firstName.addEventListener('focusout', this.checkName.bind(this, this.firstName));
        //     this.lastName.addEventListener('focusout', this.checkName.bind(this, this.lastName));
        //     this.password.addEventListener('focusout', this.checkPass.bind(this));
        //     this.email.addEventListener('focusout', this.checkEmail.bind(this));
        //     this.phone.addEventListener('focusout', this.checkPhone.bind(this));
        //     this.button.addEventListener('click', this.submitForm.bind(this));

        //     this.inputs.forEach(input => {
        //        input.addEventListener('focus', this.removeError.bind(this, input));
        //     });
        //   },

        //   submitForm(e) {
        //     e.preventDefault();
        //     if (this.allEntriesValid()) {
        //       this.formStatus.textContent = 'Success, form submitted.';
        //       this.formStatus.classList.remove('invalid_field');
        //       this.formStatus.classList.add('success');
        //     } else {
        //       this.formStatus.classList.add('invalid_field');
        //       this.formStatus.textContent = 'Error, please correct form information.';
        //     }
        //   },

        //   allEntriesValid() {
        //     return Array.from(this.inputs).every(ipt => {
        //       return (ipt.classList.contains('optional') && !ipt.classList.contains('invalid_field')) ||
        //       (!ipt.classList.contains('invalid_field') && ipt.value.length > 0)
        //     });
        //   },

        //   checkName(n) {
        //     if (!n.checkValidity()) {
        //       let val = n.id.split('name')[0];
        //       val = val[0].toUpperCase() + val.slice(1);
        //       let msg = `${val} name is a required field.`;
        //       this.addError(n, msg);
        //     } else {
        //       this.removeError(n);
        //     }
        //   },

        //   checkPass() {
        //     if (!this.password.checkValidity()) {
        //       let msg = 'Password must be 10 characters or longer.';
        //       this.addError(this.password, msg);
        //     } else {
        //       this.removeError(this.password);
        //     }
        //   },

        //   checkEmail() {
        //     if (this.email.validity.typeMismatch || this.email.value.length <= 0) {
        //       this.addError(this.email, 'Email must be in the correct format. "aaa@address"');
        //     } else {
        //       this.removeError(this.email);
        //     }
        //   },

        //   checkPhone() {
        //     let pattern = /[0-9]{3}-[0-9]{3}-[0-9]{4}/;
        //     if (!this.phone.value.match(pattern)) {
        //       this.addError(this.phone, "Phone must be in the 123-123-1234 format.");
        //     } else {
        //       this.removeError(this.phone);
        //     }
        //   },

        //   addError(el, msg) {
        //     el.classList.add('invalid_field');
        //     el.nextElementSibling.textContent = msg;
        //   },

        //   removeError(el) {
        //     el.classList.remove('invalid_field');
        //     el.nextElementSibling.textContent = '';
        //   },

        //   init() {
        //     this.bindEvents();
        //   }
        // }

        // formValidation.init();

        let formValidation = {
          form: document.querySelector('form'),
          input: document.querySelectorAll('input'),
          ccFields: document.querySelectorAll('input[name=creditcard]'),

          getNextSpanFrom(start) {
            let el = start;
            while (el.tagName !== 'SPAN') {
              el = el.nextElementSibling;
            }

            return el;
          },

          handleValueAbsence(field) {
            let labelText = document.querySelector('label[for=' + field.dataset.errorName + ']').textContent;
            let errorField = this.getNextSpanFrom(field);
            let errorMsg = labelText + ' is a required field.';
            field.classList.add('invalid_field');
            errorField.textContent = errorMsg;
          },

          handlePatternMismatch(field) {
            let labelText = document.querySelector('label[for=' + field.dataset.errorName + ']').textContent;
            let errorField = this.getNextSpanFrom(field);
            let errorMsg = 'Please enter a valid ' + labelText + '.';
            field.classList.add('invalid_field');
            errorField.textContent = errorMsg;
            if (field.getAttribute('id') === "password") {
              errorField.textContent = 'Password must be at least 10 characters long.';
            }
          },

          validateInputs(field) {
            if (field.validity.valueMissing) {
              this.handleValueAbsence(field);
              return false;
            } else if (field.validity.patternMismatch) {
              this.handlePatternMismatch(field);
              return false;
            }

            return true;
          },

          handleFocusOut(e) {
            let field = e.target;
            if (this.form.checkValidity()) {
              document.querySelector('.form_errors').textContent = '';
            }
            this.validateInputs(field);
            if (e.target.name === 'creditcard') {
              this.handleCCstatus();
            }
          },

          handleCCstatus() {
            this.ccFields.forEach(field => {
              if (field.classList.contains('invalid_field')) {
                this.getNextSpanFrom(field).textContent = 'Please enter a valid credit card.';
              }
            })
          },

          handleFocus(e) {
            let field = e.target;
            field.nextElementSibling.textContent = '';
            field.classList.remove('invalid_field');
          },

          handleFormSubmit(e) {
            e.preventDefault();
            if (this.form.checkValidity()) {
              document.querySelector('.form_errors').textContent = "Form submitted successfully.";
              document.querySelector('.form_errors').classList.add('success');
              this.submitForm();
            } else {
              document.querySelector('.form_errors').textContent = "Form cannnot be submitted until errors are corrected.";
              this.validateFormInputs();
              return false;
            }
          },

          validateFormInputs() {
            this.input.forEach(input => {
              this.validateInputs(input);
            });
          },

          blockNonNumeric(e) {
            if (!e.key.match(/[-0-9]/)) {
              e.preventDefault();
            }
          },

          autoTab(e) {
            if (e.key === 'Tab' || e.key === 'Shift') {
              return;
            }

            if (e.target.value.length === 4) {
              e.preventDefault();
              let nextField = e.target.nextElementSibling;
              nextField.focus();
            }
          },

          backShift(e) {
            if (e.key === 'Tab' && e.shiftKey) {
              e.stopPropagation();
            }
          },

          submitForm() {
            let data = new FormData(this.form);

            let dataObj = {credit_card: ''};
            for (const [name, value] of data) { 
              if (name.startsWith('credit_card')) {
                dataObj['credit_card'] +=  value
              } else {
                dataObj[name] = encodeURIComponent(value);
              }
            };

            let query = [];
            Object.keys(dataObj).forEach(k => query.push(`${k}=${dataObj[k]}`));
            let qstring = query.join('&');
            document.querySelector('#formQueryString').textContent = qstring;
          },

          init() {
            this.input.forEach (input => {
              input.addEventListener('focusout', this.handleFocusOut.bind(this));
              input.addEventListener('focus', this.handleFocus.bind(this));
            });

            document.querySelector('input[name=phone]').addEventListener('keypress', this.blockNonNumeric.bind(this));

            this.ccFields.forEach((ipt, idx) => {
              ipt.addEventListener('keypress', this.blockNonNumeric.bind(this));
              ipt.addEventListener('keydown', this.backShift.bind(this));

              if (idx !== 3) {
                ipt.addEventListener('keyup', this.autoTab.bind(this));
              }
            });

            this.form.addEventListener('submit', this.handleFormSubmit.bind(this));
          }
        }

        formValidation.init();
      });
    </script>
  </head>
  <body>
    <h1>Sign up Form</h1>
    <form method="post" action="#" novalidate>
      <p class="form_errors"></p>

      <fieldset>
        <label for="firstName">First name </label>
        <input value="aaaa" type="text" data-error-name="firstName" name="firstName" id="firstName" required class="" pattern="[a-zA-Z']+"><span class="error_message"></span><br>

        <label for="lastName">Last name </label>
        <input value="aaaa" type="text" data-error-name="lastName" name="lastName" id="lastName" required class="" pattern="[a-zA-Z']+"><span class="error_message"></span><br>

        <label for="email">Email </label>
        <input value="a@aa" type="email" data-error-name="email" name="email" id="email" placeholder="name@address" pattern=".+@.+" required class=""><span class="error_message"></span><br>

        <label for="password">Password </label>
        <input value="aaaabbbbcc" type="password" data-error-name="password" name="password" id="password" required class="" pattern=".{10,}"><span class="error_message"></span><br>

        <label for="phone">Phone Number </label>
        <input value="1231231234" type="tel" data-error-name="phone" name="phone" id="phone" class="optional" placeholder="123-123-1234" pattern="\d{10}"><span class="error_message"></span><br>

        <label for="creditcard">Credit Card </label>
        <input value="1111" type="text" maxlength="4" data-error-name="creditcard" name="credit_card1" id="cc1" class="creditCard" pattern="\d{4}" required>
        <input value="2222" type="text" maxlength="4" data-error-name="creditcard" name="credit_card2" id="cc2" class="creditCard" pattern="\d{4}" required>
        <input value="3333" type="text" maxlength="4" data-error-name="creditcard" name="credit_card3" id="cc3" class="creditCard" pattern="\d{4}" required>
        <input value="4444" type="text" maxlength="4" data-error-name="creditcard" name="credit_card4" id="cc4" class="creditCard" pattern="\d{4}" required><span class="error_message"></span><br>

        <button type="submit" id="formsubmit" value="Sign Up">Submit</button>
      </fieldset>
    </form>
    <div>
      <h1>Serialized Form</h1>
      <p id="formQueryString"></p>
    </div>
  </body>
</html>